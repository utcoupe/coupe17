<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ia/pathfinding.class.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ia_actions.Actions.html">Actions</a><ul class='methods'><li data-type='method'><a href="ia_actions.Actions.html#actionFinished">actionFinished</a></li><li data-type='method'><a href="ia_actions.Actions.html#collision">collision</a></li><li data-type='method'><a href="ia_actions.Actions.html#doAction">doAction</a></li><li data-type='method'><a href="ia_actions.Actions.html#doNextAction">doNextAction</a></li><li data-type='method'><a href="ia_actions.Actions.html#exists">exists</a></li><li data-type='method'><a href="ia_actions.Actions.html#getNearestStartpoint">getNearestStartpoint</a></li><li data-type='method'><a href="ia_actions.Actions.html#getNormAction">getNormAction</a></li><li data-type='method'><a href="ia_actions.Actions.html#getPriorityAction">getPriorityAction</a></li><li data-type='method'><a href="ia_actions.Actions.html#importActions">importActions</a></li><li data-type='method'><a href="ia_actions.Actions.html#isDoable">isDoable</a></li><li data-type='method'><a href="ia_actions.Actions.html#isDone">isDone</a></li><li data-type='method'><a href="ia_actions.Actions.html#kill">kill</a></li><li data-type='method'><a href="ia_actions.Actions.html#parseOrder">parseOrder</a></li><li data-type='method'><a href="ia_actions.Actions.html#pathDoAction">pathDoAction</a></li></ul></li><li><a href="ia_data.Data.html">Data</a><ul class='methods'><li data-type='method'><a href="ia_data.Data.html#getDistance">getDistance</a></li><li data-type='method'><a href="ia_data.Data.html#getObjectRef">getObjectRef</a></li><li data-type='method'><a href="ia_data.Data.html#importObjects">importObjects</a></li><li data-type='method'><a href="ia_data.Data.html#isCloser">isCloser</a></li><li data-type='method'><a href="ia_data.Data.html#parseOrder">parseOrder</a></li><li data-type='method'><a href="ia_data.Data.html#theEnnemyWentThere">theEnnemyWentThere</a></li></ul></li><li><a href="ia_export_simulator.ExportSimulator.html">ExportSimulator</a><ul class='methods'><li data-type='method'><a href="ia_export_simulator.ExportSimulator.html#orderToSimu">orderToSimu</a></li><li data-type='method'><a href="ia_export_simulator.ExportSimulator.html#start">start</a></li><li data-type='method'><a href="ia_export_simulator.ExportSimulator.html#stop">stop</a></li></ul></li><li><a href="ia_gr.Gr.html">Gr</a><ul class='methods'><li data-type='method'><a href="ia_gr.Gr.html#onCollision">onCollision</a></li><li data-type='method'><a href="ia_gr.Gr.html#parseOrder">parseOrder</a></li><li data-type='method'><a href="ia_gr.Gr.html#sendOrders">sendOrders</a></li><li data-type='method'><a href="ia_gr.Gr.html#sendPos">sendPos</a></li><li data-type='method'><a href="ia_gr.Gr.html#start">start</a></li><li data-type='method'><a href="ia_gr.Gr.html#stop">stop</a></li></ul></li><li><a href="ia_ia.Ia.html">Ia</a><ul class='methods'><li data-type='method'><a href="ia_ia.Ia.html#jack">jack</a></li><li data-type='method'><a href="ia_ia.Ia.html#stop">stop</a></li></ul></li><li><a href="ia_pathfinding.Pathfinding.html">Pathfinding</a><ul class='methods'><li data-type='method'><a href="ia_pathfinding.Pathfinding.html#getPath">getPath</a></li><li data-type='method'><a href="ia_pathfinding.Pathfinding.html#sendDynamic">sendDynamic</a></li><li data-type='method'><a href="ia_pathfinding.Pathfinding.html#sendQuery">sendQuery</a></li><li data-type='method'><a href="ia_pathfinding.Pathfinding.html#updateMap">updateMap</a></li><li data-type='method'><a href="ia_pathfinding.Pathfinding.html#~parse">parse</a></li><li data-type='method'><a href="ia_pathfinding.Pathfinding.html#~vecMultiply">vecMultiply</a></li></ul></li><li><a href="ia_timer.Timer.html">Timer</a><ul class='methods'><li data-type='method'><a href="ia_timer.Timer.html#get">get</a></li><li data-type='method'><a href="ia_timer.Timer.html#start">start</a></li><li data-type='method'><a href="ia_timer.Timer.html#status">status</a></li></ul></li><li><a href="server_server.Server.html">Server</a><ul class='methods'><li data-type='method'><a href="server_server.Server.html#launch">launch</a></li><li data-type='method'><a href="server_server.Server.html#sendNetwork">sendNetwork</a></li><li data-type='method'><a href="server_server.Server.html#sendUTCoupe">sendUTCoupe</a></li><li data-type='method'><a href="server_server.Server.html#stop">stop</a></li></ul></li><li><a href="server_server.SocketClient.html">SocketClient</a><ul class='methods'><li data-type='method'><a href="server_server.SocketClient.html#connect">connect</a></li><li data-type='method'><a href="server_server.SocketClient.html#errorServerNotFound">errorServerNotFound</a></li><li data-type='method'><a href="server_server.SocketClient.html#errorServerTimeout">errorServerTimeout</a></li><li data-type='method'><a href="server_server.SocketClient.html#order">order</a></li><li data-type='method'><a href="server_server.SocketClient.html#send">send</a></li><li data-type='method'><a href="server_server.SocketClient.html#throwError">throwError</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-config.html">config</a></li><li><a href="module-ia_actions.html">ia/actions</a></li><li><a href="module-ia_data.html">ia/data</a></li><li><a href="module-ia_export_simulator.html">ia/export_simulator</a></li><li><a href="module-ia_gr.html">ia/gr</a></li><li><a href="module-ia_ia.html">ia/ia</a></li><li><a href="module-ia_pathfinding.html">ia/pathfinding</a></li><li><a href="module-ia_pr.html">ia/pr</a></li><li><a href="module-ia_timer.html">ia/timer</a></li><li><a href="module-server_server.html">server/server</a></li><li><a href="module-server_socket_client.html">server/socket_client</a></li><li><a href="module-utcoupe_utcoupe.html">utcoupe/utcoupe</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">ia/pathfinding.class.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Pathfinding module
 * 
 * @module ia/pathfinding
 * @see {@link ia/pathfinding.Pathfinding}
 */

module.exports = (function () {
	"use strict";

	var Path = require('path');

	var programm = Path.normalize("./pathfinding/bin/pathfinding");
	var image = Path.normalize("./pathfinding/img/map-20mm-yellow.bmp");
	var RATIO = 20;
	var SEPARATOR = ";";

	var logger = require('log4js').getLogger('ia.pathfinding');
	var Child_process = require('child_process');
	var Byline = require('byline');

	/**
	 * Pathfinding constructor
	 * 
	 * @exports ia/pathfinding.Pathfinding
	 * @constructor
	 * @param {Ia} ia
	 */
	function Pathfinding(ia) {
		/** Ia */
		this.ia = ia;
		var fifo = [];

		/*var instance_pkill = Child_process.spawn("pkill", ["pathfinding"]);
		instance_pkill.on('error', function(err){
			logger.error("error pkilling pathfinding code:"+err.code);
		});
		instance_pkill.on('exit', function(code){
			logger.info("successfully pkilled all old instances of pathfinding");
		});


		var instance = Child_process.spawn(programm, [ image ]);*/
		var instance = Child_process.spawn("bash", ["-c", "pkill pathfinding;"+programm+" "+image]);

		instance.on('error', function(err) {
			if(err.code === 'ENOENT'){
				logger.fatal("pathfinding programm executable not found! Is it compiled ? :) Was looking in \""+Path.resolve(programm)+"\"");
				process.exit();
			}
			logger.error("c++ subprocess terminated with error:", err);
			console.log(err);
		});
		instance.on('exit', function(code) {
			logger.fatal("c++ subprocess terminated with code:"+code);
		});



		process.on('exit', function(){ //ensure child process is killed
			if(instance.connected){ //and was still connected (dont kill another process)
				instance.kill();
			}
		});

		var stdout = Byline.createStream(instance.stdout);
		stdout.setEncoding('utf8')
		stdout.on('data', function(data) {
			logger.debug("Received: "+data);
			parse(data);
		});

		instance.stderr.on('data', function(data) {
			logger.error("stderr :"+data.toString());
		});

		/**
		 * Vector Multiply
		 * 
		 * @param {Object} arr
		 * @param {int} ratio
		 */
		function vecMultiply(arr, ratio){
			return arr.map(function(val){
				return Math.round(val*ratio);
			});
		}

		/**
		 * Send a Query
		 * 
		 * @param start
		 * @param end
		 * @param cb
		 */
		this.sendQuery = function(start, end, cb){
			fifo.push(cb || true);


			var str = ["C"].concat( vecMultiply(start, 1/RATIO) ).concat( vecMultiply(end, 1/RATIO) ).join(SEPARATOR) + "\n";
			instance.stdin.write( str );
			logger.info("Sending:"+str);
		};

		/**
		 * Send Dynamic
		 * 
		 * @param {Object} objects
		 */
		this.sendDynamic = function(objects){
			//X0, Y0, R0, ...
			var str = ["D"].concat(objects.reduce(function(acc, obj){
				return acc.concat( vecMultiply(obj, 1/RATIO) );
			}, [])).join(SEPARATOR) + "\n";
			// logger.debug(str);
			instance.stdin.write(str);
		}

		/**
		 * Parse data
		 * 
		 * @param {Object} data
		 */
		function parse (data) {
			// X0; Y0; ... Xn; Yn
			var ret = null;
			if(data != "FAIL") {
				var path = [];
				var splitted = data.split(SEPARATOR);
				while(splitted.length > 1){
					path.push( vecMultiply([splitted.shift(), splitted.shift()], RATIO) );
				}

				
				if(path.length > 0) ret = path;
			}

			var callback = fifo.shift();
			callback(ret); // if(typeof callback === "function") 
		}

	}

	/**
	 * Get Path
	 * 
	 * @param start
	 * @param end
	 * @param callback
	 */
	Pathfinding.prototype.getPath = function (start, end, callback) {
		this.ia.pathfinding.updateMap();
		this.timeout_getpath = setTimeout(function() {
			callback(null);
			callback = function() {};
		}, 1000);
		this.sendQuery([start.x, start.y], [end.x, end.y], function(path){
			clearTimeout(this.timeout_getpath);
			if(path !== null) {
				path.shift();
				path = path.map(function(val) {
					return {
						x: val[0],
						y: val[1]
					};
				});
			}
			callback(path);
		}.bind(this));
	};

	/**
	 * Borne
	 * 
	 * @param {int} x
	 * @param {int} min
	 * @param {int} max
	 */
	function borne(x, min, max) {
		return x > max ? max : x &lt; min ? min : x;
	}
	
	/**
	 * Update Map
	 */
	Pathfinding.prototype.updateMap = function () {
		//[ [x, y, r], ... ]

		// var objects = [];
		// objects.push();
		var objects = [{
			pos: this.ia.gr.pos,
			d: this.ia.gr.size.d
		}].concat(this.ia.data.dots).concat(this.ia.data.dynamic);


		// logger.debug(objects);

		this.sendDynamic( objects.map(function(val){
			// logger.debug(val);
			return [borne(val.pos.x, 0, 2980), borne(val.pos.y, 0, 1980), 1*((val.d/2)+(this.ia.pr.size.d/2))];
		}.bind(this)) );
	};

	return Pathfinding;
})();

/*
(function(){
	var pathfinding = new module.exports();
	function log(result){
		console.log("RESULT", result);
		process.exit();
	}

	setTimeout(function(){
		pathfinding.getPath([500,1000], [1500, 200], log);
	}, 10);
})();
//*/
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Nov 11 2016 17:47:36 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
